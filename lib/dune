(rule
 (enabled_if
  (= %{system} macosx))
 (deps
  (source_tree ../rust))
 (targets libpolars_ocaml.a dllpolars_ocaml.so)
 (action
  (no-infer
   (progn
    (chdir
     ../rust
     (run cargo build))
    (copy ../rust/target/debug/libpolars_ocaml.dylib dllpolars_ocaml.so)
    (copy ../rust/target/debug/libpolars_ocaml.a libpolars_ocaml.a)))))

(rule
 (enabled_if
  (<> %{system} macosx))
 (deps
  (source_tree ../rust))
 (targets libpolars_ocaml.a dllpolars_ocaml.so)
 (action
  (no-infer
   (progn
    (chdir
     ../rust
     (run cargo build))
    (copy ../rust/target/debug/libpolars_ocaml.so dllpolars_ocaml.so)
    (copy ../rust/target/debug/libpolars_ocaml.a libpolars_ocaml.a)))))

(library
 (name polars)
 (public_name polars)
 (foreign_archives polars_ocaml)
 (libraries core core_kernel.nonempty_list)
 (inline_tests)
 (preprocess
  (pps ppx_jane))
 (c_library_flags -framework CoreFoundation -framework IOKit))

(env
 (utop
  (env-vars
   (OCAML_INTEROP_NO_CAML_STARTUP true))))
