name: Build
on: [push, pull_request]
env:
  CARGO_TERM_COLOR: always
jobs:
  build-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: 4.14.x
      # These environment variables are used by ocaml-sys to figure out which
      # compiler we're building for
      - name: Set up opam env
        run: |
          opam env >> $GITHUB_ENV
          opam var bin >> $GITHUB_PATH
      - uses: rui314/setup-mold@v1
      # By default setup-mold replaces the linker with mold, so we don't need
      # the config.toml file in github actions.
      - run: rm ./rust/.cargo/config.toml
      - name: Check
        run: cargo check --verbose
        working-directory: ./rust
      - name: Build
        run: cargo build --verbose
        working-directory: ./rust
      - name: Run tests
        run: cargo test --verbose
        working-directory: ./rust
      - name: Clippy
        uses: giraffate/clippy-action@v1
        with:
          reporter: "github-pr-review"
          github_token: ${{ secrets.GITHUB_TOKEN }}
